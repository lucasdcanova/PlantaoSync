services:
  # ── Unified server (NestJS API + Next.js Frontend) ──────────────────
  - type: web
    name: plantaosync
    runtime: node
    region: oregon
    plan: starter
    buildCommand: >-
      npm install -g pnpm &&
      pnpm install --frozen-lockfile &&
      pnpm --filter=api run db:generate &&
      pnpm run build --filter=web... &&
      pnpm --filter=api run build
    startCommand: node server.js
    envVars:
      - key: NODE_VERSION
        value: "20"
      - key: NODE_ENV
        value: production
      - key: APP_URL
        value: https://plantaosync.onrender.com
      - key: FRONTEND_URL
        value: https://plantaosync.onrender.com
      - key: CORS_ORIGINS
        value: https://plantaosync.onrender.com
      - key: NEXT_PUBLIC_APP_ENV
        value: production
      - key: NEXT_PUBLIC_APP_URL
        value: https://plantaosync.onrender.com
      - key: NEXT_PUBLIC_API_URL
        value: https://plantaosync.onrender.com
      - key: NEXT_PUBLIC_WS_URL
        value: wss://plantaosync.onrender.com
      - key: DATABASE_URL
        sync: false
      - key: DIRECT_URL
        sync: false
      - key: JWT_ACCESS_SECRET
        sync: false
      - key: JWT_ACCESS_EXPIRES_IN
        value: "15m"
      - key: JWT_REFRESH_SECRET
        sync: false
      - key: JWT_REFRESH_EXPIRES_IN
        value: "30d"
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: AWS_S3_REGION
        value: "sa-east-1"
      - key: AWS_S3_BUCKET
        value: "plantaosync-storage"
